name: Laravel CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  laravel-tests:
    name: Run Laravel Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer

    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    - name: Install Dependencies
      run: composer install --no-dev --no-progress --prefer-dist

    - name: Generate Application Key
      run: php artisan key:generate

    - name: Set Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: Set Up SQLite Database (temporary for testing)
      run: |
        mkdir -p database
        touch database/database.sqlite

    # - name: Run Tests
    #   env:
    #     DB_CONNECTION: mysql
    #     DB_HOST: ${{ secrets.DB_HOST }}
    #     DB_PORT: ${{ secrets.DB_PORT }}
    #     DB_DATABASE: ${{ secrets.DB_DATABASE }}
    #     DB_USERNAME: ${{ secrets.DB_USERNAME }}
    #     DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    #   run: php artisan test

  deploy:
    name: Deploy to EC2
    needs: laravel-tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer

    - name: Install Dependencies
      run: composer install --no-dev --no-progress --prefer-dist

    - name: Build Assets
      run: npm ci && npm run production

    - name: Sync Files to EC2
      env:
        SSH_KEY: s8LzAmSrfh2/9F6SgMCLTP+PDR5YTnqvVIuh/+/hnH2jCeNq11gvxzOH6v3hMLi6
yxpCHRdCTnnfYc945ONi0ZwjzsOQyxN9Wp5ToKN7JkM2EjiTE814D3BCyA7NEL1C
MpiSywWC+zN+LxVCmBf0IXtoDfnM+VS818j/qPT4leoiCNObLJlWIyC7rqLHsZrw
EHYe+cgKDs3i+QiZKmHJnlCfYMonoauUxrmbjwIDAQABAoIBACWXDOGHuPOnAj1Y
bcGzkALSXwOAKQ4ThtSzSNG5t9mMtd79HLmUdXY5K9WKya2dyQbN7Ljv62HG21lK
jy0ixiGToGeITZslqM1JNLaR3X9+sHT1t6NnD7PIKDDxs6TgoxXmRJU/kGMQ/cgn
kyQ+NJ6bVSMBghIXpFsT8FusGzPtz2yUmtSokhBviZ6Ce08swR5hizztv7Q29ixg
pO7P1w9E3ZWzGdzaYSlDwXnGUagBSJgBFf7v1Adl8/C4hCSJP5FrmBCl294lwokA
c1J1latw1l3Tkj1PTJSpl5mumCIu3LBgmxcuoBjZEXYXoLccsAKTLj9H2i4WahN3
Zu6v5VECgYEAxuM0mxKpfFZmI7nksjXwkcVi29u3WwMvXdAZXpCO0rQY+hD0r013
hsDk0Ipq5f9Vo+POaySohPxCjgSrHk6FsUR29k7iNlFvI+sz/Mmxhy97/Y2OofxU
cHsgS6ld+fZNgmdtmwc05Wru+HRrheqICchmKMgUHZ2sxbWQZHjLOcMCgYEAwKuX
O/q2ijeIPaB+/4oBzZh6AAgD4k46eSx1orutC0gg58RRbSqKY3eSmBDEmfC3KRfg
d6wh2F+jg/Z+l7vEi6eDWibgDb4iTvs6qM1WttVE0B9RM7FCgUWFK2aYI7vlK2si
DDZORVtP/ttq0A6S3bpYsfCdm6VtVNO5d7MGLkUCgYABpqEpKF5/ybfPVBux3wDA
NQM9D/XVq5EZFkEfp9OHrDcI3FsrmVkEpVVA5eU9Q4FSevGbshI0CGQFCcTh24UA
k7DpGn6GNObXRXyI/KOcm6hL0oD8lzucM2lxN1awXHsIOhOO1eB6hwi0x0KdOfUn
H6K5c++2zzg/6+Hm85m8QQKBgQCWyfRbqdURCXMkICckoYLVwF7DBYLcq7LRwPzz
9oPwz2uJWDkOAfw66osdXgowHJeMnrY7kskOSZN0pQbgg8DIN7ryZHh36PV68N4w
3DvgbbskU04+8Z0GBT27ANlTJiuuNnN4MUxCtbs+z8ShvrYsuDnQUWtYNDkD6Yw+
5SqSLQKBgBe5ERStgHXO/ILO3yWtc9kFMhJrLNfZ9lUuKaHtJpLv0eDbbd0g8siY
JebCwaWhIzE7OzOYv2ycEg4Giw4Co61rmLXlOpfMoREAgPJtKfhZAuql6XLHwHE+
+Syjzb6AZmQhdw9nDYPeXFOHZ7VY++6gzaOUQw5uWIE82St/76tm
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        rsync -az --delete --exclude="node_modules" --exclude=".git" \
        ./ $USER@$HOST:/var/www/laravel

    - name: Run Laravel Commands on EC2
      env:
        SSH_KEY: s8LzAmSrfh2/9F6SgMCLTP+PDR5YTnqvVIuh/+/hnH2jCeNq11gvxzOH6v3hMLi6
yxpCHRdCTnnfYc945ONi0ZwjzsOQyxN9Wp5ToKN7JkM2EjiTE814D3BCyA7NEL1C
MpiSywWC+zN+LxVCmBf0IXtoDfnM+VS818j/qPT4leoiCNObLJlWIyC7rqLHsZrw
EHYe+cgKDs3i+QiZKmHJnlCfYMonoauUxrmbjwIDAQABAoIBACWXDOGHuPOnAj1Y
bcGzkALSXwOAKQ4ThtSzSNG5t9mMtd79HLmUdXY5K9WKya2dyQbN7Ljv62HG21lK
jy0ixiGToGeITZslqM1JNLaR3X9+sHT1t6NnD7PIKDDxs6TgoxXmRJU/kGMQ/cgn
kyQ+NJ6bVSMBghIXpFsT8FusGzPtz2yUmtSokhBviZ6Ce08swR5hizztv7Q29ixg
pO7P1w9E3ZWzGdzaYSlDwXnGUagBSJgBFf7v1Adl8/C4hCSJP5FrmBCl294lwokA
c1J1latw1l3Tkj1PTJSpl5mumCIu3LBgmxcuoBjZEXYXoLccsAKTLj9H2i4WahN3
Zu6v5VECgYEAxuM0mxKpfFZmI7nksjXwkcVi29u3WwMvXdAZXpCO0rQY+hD0r013
hsDk0Ipq5f9Vo+POaySohPxCjgSrHk6FsUR29k7iNlFvI+sz/Mmxhy97/Y2OofxU
cHsgS6ld+fZNgmdtmwc05Wru+HRrheqICchmKMgUHZ2sxbWQZHjLOcMCgYEAwKuX
O/q2ijeIPaB+/4oBzZh6AAgD4k46eSx1orutC0gg58RRbSqKY3eSmBDEmfC3KRfg
d6wh2F+jg/Z+l7vEi6eDWibgDb4iTvs6qM1WttVE0B9RM7FCgUWFK2aYI7vlK2si
DDZORVtP/ttq0A6S3bpYsfCdm6VtVNO5d7MGLkUCgYABpqEpKF5/ybfPVBux3wDA
NQM9D/XVq5EZFkEfp9OHrDcI3FsrmVkEpVVA5eU9Q4FSevGbshI0CGQFCcTh24UA
k7DpGn6GNObXRXyI/KOcm6hL0oD8lzucM2lxN1awXHsIOhOO1eB6hwi0x0KdOfUn
H6K5c++2zzg/6+Hm85m8QQKBgQCWyfRbqdURCXMkICckoYLVwF7DBYLcq7LRwPzz
9oPwz2uJWDkOAfw66osdXgowHJeMnrY7kskOSZN0pQbgg8DIN7ryZHh36PV68N4w
3DvgbbskU04+8Z0GBT27ANlTJiuuNnN4MUxCtbs+z8ShvrYsuDnQUWtYNDkD6Yw+
5SqSLQKBgBe5ERStgHXO/ILO3yWtc9kFMhJrLNfZ9lUuKaHtJpLv0eDbbd0g8siY
JebCwaWhIzE7OzOYv2ycEg4Giw4Co61rmLXlOpfMoREAgPJtKfhZAuql6XLHwHE+
+Syjzb6AZmQhdw9nDYPeXFOHZ7VY++6gzaOUQw5uWIE82St/76tm
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_DATABASE: ${{ secrets.DB_DATABASE }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        ssh -i "laravel.pem" ubuntu@ec2-35-154-241-153.ap-south-1.compute.amazonaws.com
          cd /var/www/laravel
          composer install --no-dev --no-progress --prefer-dist
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
        EOF
