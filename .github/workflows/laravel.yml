name: Laravel CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  laravel-tests:
    name: Run Laravel Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer

    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    - name: Install Dependencies
      run: composer install --no-dev --no-progress --prefer-dist

    - name: Generate Application Key
      run: php artisan key:generate

    - name: Set Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: Set Up SQLite Database (temporary for testing)
      run: |
        mkdir -p database
        touch database/database.sqlite

    # - name: Run Tests
    #   env:
    #     DB_CONNECTION: mysql
    #     DB_HOST: ${{ secrets.DB_HOST }}
    #     DB_PORT: ${{ secrets.DB_PORT }}
    #     DB_DATABASE: ${{ secrets.DB_DATABASE }}
    #     DB_USERNAME: ${{ secrets.DB_USERNAME }}
    #     DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    #   run: php artisan test

 name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
      env:
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

    - name: Add host to known_hosts
      run: ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
      env:
        HOST: 35.154.241.153

    - name: Test SSH connection
      run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $USER@$HOST "echo 'SSH connection successful!'"
      env:
        USER: ubuntu
        HOST: 35.154.241.153

    - name: Deploy files using rsync
      run: |
        rsync -az --delete --exclude="node_modules" --exclude=".git" \
          -e "ssh -i ~/.ssh/id_rsa" ./ $USER@$HOST:/var/www/laravel
      env:
        USER: ubuntu
        HOST: 35.154.241.153
